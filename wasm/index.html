<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>LED Effect Preview</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            margin: 0;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        label {
            font-size: 12px;
            color: #888;
        }
        select, input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #2a2a4e;
            color: #eee;
        }
        #led-strip {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            padding: 20px;
            background: #111;
            border-radius: 8px;
        }
        .led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #000;
            box-shadow: 0 0 3px rgba(255,255,255,0.1);
        }
        #status {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>LED Effect Preview</h1>

    <div class="controls">
        <div class="control-group">
            <label>Effect</label>
            <select id="effect"></select>
        </div>
        <div class="control-group">
            <label>Color</label>
            <input type="color" id="color" value="#ff6600">
        </div>
        <div class="control-group">
            <label>Speed (1-10)</label>
            <input type="range" id="speed" min="1" max="10" value="5">
        </div>
        <div class="control-group">
            <label>Brightness</label>
            <input type="range" id="brightness" min="0" max="255" value="255">
        </div>
        <div class="control-group">
            <label>LED Count</label>
            <input type="number" id="ledCount" min="1" max="300" value="60">
        </div>
    </div>

    <div id="led-strip"></div>
    <div id="status">Loading WASM module...</div>

    <script src="pixel_preview.js"></script>
    <script>
        let preview = null;
        let animationId = null;

        async function init() {
            try {
                const Module = await createPixelPreview();
                const ledCount = parseInt(document.getElementById('ledCount').value);
                preview = new Module.PixelPreview(ledCount, false, 60);

                // Populate effect dropdown
                const effects = Module.PixelPreview.getEffectList();
                const effectSelect = document.getElementById('effect');
                for (let i = 0; i < effects.length; i++) {
                    const option = document.createElement('option');
                    option.value = effects[i];
                    option.textContent = effects[i];
                    effectSelect.appendChild(option);
                }

                // Set initial values
                updateEffect();
                updateColor();
                updateSpeed();
                updateBrightness();

                // Create LED elements
                createLEDs(ledCount);

                // Start animation
                animate();

                document.getElementById('status').textContent = 'WASM module loaded successfully!';

                // Event listeners
                document.getElementById('effect').addEventListener('change', updateEffect);
                document.getElementById('color').addEventListener('input', updateColor);
                document.getElementById('speed').addEventListener('input', updateSpeed);
                document.getElementById('brightness').addEventListener('input', updateBrightness);
                document.getElementById('ledCount').addEventListener('change', updateLedCount);

            } catch (err) {
                document.getElementById('status').textContent = 'Error: ' + err.message;
                console.error(err);
            }
        }

        function createLEDs(count) {
            const strip = document.getElementById('led-strip');
            strip.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const led = document.createElement('div');
                led.className = 'led';
                led.id = 'led-' + i;
                strip.appendChild(led);
            }
        }

        function updateEffect() {
            if (preview) {
                preview.setEffect(document.getElementById('effect').value);
            }
        }

        function updateColor() {
            if (preview) {
                const hex = document.getElementById('color').value;
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                preview.setColor(r, g, b, 0);
            }
        }

        function updateSpeed() {
            if (preview) {
                preview.setSpeed(parseInt(document.getElementById('speed').value));
            }
        }

        function updateBrightness() {
            if (preview) {
                preview.setBrightness(parseInt(document.getElementById('brightness').value));
            }
        }

        async function updateLedCount() {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            const Module = await createPixelPreview();
            const ledCount = parseInt(document.getElementById('ledCount').value);
            preview = new Module.PixelPreview(ledCount, false, 60);
            createLEDs(ledCount);
            updateEffect();
            updateColor();
            updateSpeed();
            updateBrightness();
            animate();
        }

        function animate() {
            if (preview) {
                preview.tick();

                // Get frame data
                const frameData = preview.getFrameData();
                const ledCount = preview.getLedCount();

                // Update LED elements
                for (let i = 0; i < ledCount; i++) {
                    const r = frameData[i * 4];
                    const g = frameData[i * 4 + 1];
                    const b = frameData[i * 4 + 2];
                    const led = document.getElementById('led-' + i);
                    if (led) {
                        led.style.background = `rgb(${r}, ${g}, ${b})`;
                        led.style.boxShadow = `0 0 ${Math.max(r, g, b) / 25}px rgb(${r}, ${g}, ${b})`;
                    }
                }
            }

            animationId = requestAnimationFrame(animate);
        }

        init();
    </script>
</body>
</html>
